name: DevNetOps - Deploy to GNS3 Routers

# Trigger workflow on push to main branch or manual dispatch
on:
  push:
    branches:
      - main
    paths:
      - 'configs/**'
      - 'scripts/**'
      - '.github/workflows/deploy.yml'

  pull_request:
    branches:
      - main
    paths:
      - 'configs/**'

  workflow_dispatch:
    inputs:
      task:
        description: 'Select task to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - interfaces
          - routing
          - vlans
          - backup

  schedule:
    # Run backup daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  validate:
    name: Validate Configuration Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml yamllint

      - name: Validate YAML files
        run: |
          echo "Validating YAML configuration files..."
          for file in configs/*.yml; do
            echo "Checking $file"
            python -c "import yaml; yaml.safe_load(open('$file'))"
          done
          echo "âœ“ All YAML files are valid"

  deploy-interfaces:
    name: Configure Interfaces
    needs: validate
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.task == 'all' || github.event.inputs.task == 'interfaces'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Configure Router Interfaces
        env:
          ROUTER_USERNAME: ${{ secrets.ROUTER_USERNAME }}
          ROUTER_PASSWORD: ${{ secrets.ROUTER_PASSWORD }}
          ROUTER_SECRET: ${{ secrets.ROUTER_SECRET }}
        run: |
          echo "ðŸ”§ Configuring interfaces on routers..."
          python scripts/configure_interfaces.py

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: interface-logs
          path: interface_config.log

  deploy-routing:
    name: Configure Routing
    needs: [validate, deploy-interfaces]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.task == 'all' || github.event.inputs.task == 'routing'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Configure Routing Protocols
        env:
          ROUTER_USERNAME: ${{ secrets.ROUTER_USERNAME }}
          ROUTER_PASSWORD: ${{ secrets.ROUTER_PASSWORD }}
          ROUTER_SECRET: ${{ secrets.ROUTER_SECRET }}
        run: |
          echo "ðŸ›£ï¸ Configuring routing protocols..."
          python scripts/configure_routing.py

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: routing-logs
          path: routing_config.log

  deploy-vlans:
    name: Configure VLANs
    needs: validate
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.task == 'all' || github.event.inputs.task == 'vlans'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Configure VLANs
        env:
          ROUTER_USERNAME: ${{ secrets.ROUTER_USERNAME }}
          ROUTER_PASSWORD: ${{ secrets.ROUTER_PASSWORD }}
          ROUTER_SECRET: ${{ secrets.ROUTER_SECRET }}
        run: |
          echo "ðŸ·ï¸ Configuring VLANs..."
          python scripts/configure_vlans.py

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: vlan-logs
          path: vlan_config.log

  backup-configs:
    name: Backup Configurations
    needs: [deploy-interfaces, deploy-routing, deploy-vlans]
    runs-on: ubuntu-latest
    if: |
      always() &&
      (github.event_name == 'push' ||
       github.event_name == 'schedule' ||
       (github.event_name == 'workflow_dispatch' &&
        (github.event.inputs.task == 'all' || github.event.inputs.task == 'backup')))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Backup Router Configurations
        env:
          ROUTER_USERNAME: ${{ secrets.ROUTER_USERNAME }}
          ROUTER_PASSWORD: ${{ secrets.ROUTER_PASSWORD }}
          ROUTER_SECRET: ${{ secrets.ROUTER_SECRET }}
        run: |
          echo "ðŸ’¾ Backing up router configurations..."
          python scripts/backup_configs.py

      - name: Commit backup files
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add backups/
          git diff --staged --quiet || git commit -m "ðŸ”„ Auto-backup: $(date +'%Y-%m-%d %H:%M:%S')"

      - name: Push backups to repository
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      - name: Upload backup artifacts
        uses: actions/upload-artifact@v3
        with:
          name: router-backups
          path: backups/
          retention-days: 90

  notify:
    name: Send Notification
    needs: [deploy-interfaces, deploy-routing, deploy-vlans, backup-configs]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check job status
        run: |
          echo "Deployment Status:"
          echo "=================="
          echo "Interfaces: ${{ needs.deploy-interfaces.result }}"
          echo "Routing: ${{ needs.deploy-routing.result }}"
          echo "VLANs: ${{ needs.deploy-vlans.result }}"
          echo "Backup: ${{ needs.backup-configs.result }}"

      - name: Create summary
        run: |
          echo "## ðŸš€ DevNetOps Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Task | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Interface Configuration | ${{ needs.deploy-interfaces.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Routing Configuration | ${{ needs.deploy-routing.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| VLAN Configuration | ${{ needs.deploy-vlans.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration Backup | ${{ needs.backup-configs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
